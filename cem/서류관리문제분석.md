# 서류 관리 문제 분석 및 해결 방안

**작성일**: 2025-10-26  
**문제**: 장비 및 인력 등록 시 입력한 필수서류가 서류관리 페이지에서 보이지 않음

---

## 1. 현재 시스템 구조

### 데이터베이스
- **`docs_compliance` 테이블**: 장비 및 인력의 서류를 저장
  - `target_type`: "equipment" | "worker"
  - `target_id`: 장비 또는 인력 ID
  - `doc_type_id`: 서류 유형 ID
  - `file_url`: 업로드된 파일 URL
  - `status`: "pending_admin" | "approved" | "rejected"

### 백엔드 API
- **`equipment.createWithDocs`**: 장비 + 서류 통합 등록 (구현됨 ✅)
- **`workers.createWithDocs`**: 인력 + 서류 통합 등록 (구현됨 ✅)
- **`docsCompliance.list`**: 모든 서류 조회 (구현됨 ✅)

### 프론트엔드
- **Equipment.tsx**: 장비 등록 폼 (`createWithDocs` 사용 ✅)
- **Documents.tsx**: 서류 관리 페이지 (조회 기능 ✅)

---

## 2. 문제 원인 분석

### 가능한 원인

#### A. Storage 설정 문제 (가장 가능성 높음)
`storage.ts`는 Manus 내장 스토리지를 사용하는데, 환경 변수가 설정되지 않았을 가능성:
- `BUILT_IN_FORGE_API_URL`
- `BUILT_IN_FORGE_API_KEY`

이 환경 변수가 없으면 `storagePut` 함수가 실패하여 서류가 저장되지 않습니다.

#### B. 에러 처리 문제
`createWithDocs` 라우터에서 서류 업로드 실패 시 에러를 catch하고 계속 진행합니다 (line 483-486):
```typescript
} catch (error) {
  console.error("[Equipment] Error uploading document:", error);
  // 에러가 발생해도 계속 진행 (일부 서류만 업로드 실패)
}
```

이로 인해 **장비는 등록되지만 서류는 저장되지 않는 상황**이 발생할 수 있습니다.

#### C. 데이터 조회 문제
`getAllDocsCompliance` 함수가 올바르게 데이터를 가져오지 못할 가능성이 있습니다.

---

## 3. 해결 방안

### 방안 1: Storage 대체 (권장)
Manus 내장 스토리지 대신 **Supabase Storage**를 사용하도록 수정:

1. **Supabase Storage 버킷 생성**
   - Supabase 대시보드에서 `equipment-docs`, `worker-docs` 버킷 생성
   - Public 접근 허용 설정

2. **`storagePut` 함수 수정**
   ```typescript
   export async function storagePut(
     relKey: string,
     data: Buffer | Uint8Array | string,
     contentType = "application/octet-stream"
   ): Promise<{ key: string; url: string }> {
     const supabase = getSupabase();
     if (!supabase) throw new Error("Supabase not available");
     
     const { data: uploadData, error } = await supabase.storage
       .from('equipment-docs')
       .upload(relKey, data, {
         contentType,
         upsert: true,
       });
     
     if (error) throw error;
     
     const { data: { publicUrl } } = supabase.storage
       .from('equipment-docs')
       .getPublicUrl(relKey);
     
     return { key: relKey, url: publicUrl };
   }
   ```

### 방안 2: Base64 직접 저장 (임시 해결책)
파일을 업로드하지 않고 **base64 데이터를 직접 `file_url`에 저장**:

```typescript
// 서류 정보 DB 저장
await db.createDocsCompliance({
  id: nanoid(),
  targetType: "equipment",
  targetId: equipmentId,
  docTypeId: doc.docTypeId,
  docType: doc.docName,
  fileName: doc.fileName,
  fileUrl: `data:${doc.mimeType};base64,${doc.fileData}`, // base64 직접 저장
  fileSize: buffer.length,
  mimeType: doc.mimeType,
  issueDate: doc.issueDate ? new Date(doc.issueDate) : undefined,
  expiryDate: doc.expiryDate ? new Date(doc.expiryDate) : undefined,
  uploadedBy: ctx.user.id,
  status: "pending_admin",
});
```

**장점**: 즉시 작동, 외부 스토리지 불필요  
**단점**: 데이터베이스 용량 증가, 성능 저하 가능

### 방안 3: 서류 CRUD 기능 추가
서류관리 페이지에서 직접 서류를 추가/수정/삭제할 수 있도록 기능 추가:

1. **서류 추가 다이얼로그**
   - 장비/인력 선택
   - 서류 유형 선택
   - 파일 업로드
   - 발급일/만료일 입력

2. **서류 수정 기능**
   - 파일 교체
   - 날짜 수정

3. **서류 삭제 기능**
   - 서류 삭제 (soft delete 또는 hard delete)

---

## 4. 권장 구현 순서

### Phase 1: 임시 해결 (Base64 저장)
1. `createWithDocs` 라우터 수정 - base64 직접 저장
2. 테스트: 장비 등록 후 서류관리 페이지에서 확인
3. 예상 시간: 30분

### Phase 2: 서류 CRUD 구현
1. 서류 추가 API 구현
2. 서류 수정 API 구현
3. 서류 삭제 API 구현
4. Documents.tsx에 CRUD UI 추가
5. 예상 시간: 2-3시간

### Phase 3: Supabase Storage 전환 (선택)
1. Supabase Storage 버킷 생성
2. `storage.ts` 수정
3. 기존 base64 데이터를 Supabase Storage로 마이그레이션
4. 예상 시간: 1-2시간

---

## 5. 즉시 적용 가능한 해결책

**Base64 직접 저장 방식**을 먼저 구현하여 문제를 즉시 해결하고, 이후 Supabase Storage로 전환하는 것을 권장합니다.

### 수정할 파일
1. `server/routers.ts` - `equipment.createWithDocs` 수정
2. `server/routers.ts` - `workers.createWithDocs` 수정

### 추가 구현 필요
1. `server/routers.ts` - `docsCompliance.update` 추가
2. `server/routers.ts` - `docsCompliance.delete` 추가
3. `client/src/pages/Documents.tsx` - 수정/삭제 UI 추가

---

**다음 단계**: Base64 직접 저장 방식으로 수정하시겠습니까?

