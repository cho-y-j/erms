# 건설장비 및 인력 관리 시스템 (ERMS) - TODO 및 작업 가이드

**마지막 업데이트**: 2025-11-07
**프로젝트**: Equipment and Resource Management System (ERMS)
**Supabase 프로젝트**: erms (zlgehckxiuhjpfjlaycf) - ACTIVE_HEALTHY
**현재 단계**: 🧪 **테스트 및 UI 개선 단계**

---

## 🎉 오늘 완료한 작업 (2025-11-07)

### ✅ 반입 요청 전체 보기 기능 추가

**구현 내용:**
- ✅ `client/src/components/EntryRequestDetail.tsx`: "전체 보기" 버튼 추가
- ✅ PDF를 다운로드 없이 브라우저 새 탭에서 직접 볼 수 있는 기능
- ✅ Base64 PDF를 Blob으로 변환하여 window.open()으로 표시
- ✅ 모바일 Inspector도 작업계획서를 브라우저에서 볼 수 있도록 개선

### ✅ UI 개선: EP 승인 화면 버튼 크기 조정

**문제점:**
- EP 승인 화면에서 버튼이 길어서 좌우 스크롤 발생

**해결:**
- ✅ 모든 버튼에 `size="sm"` 적용
- ✅ 버튼 텍스트 간결화 ("전체 PDF 다운로드" → "다운로드")
- ✅ 아이콘 여백 축소 (mr-2 → mr-1)
- ✅ DialogFooter에 flex-wrap 추가

### ✅ 투입 관리 개선 (근본 문제 해결)

**발견된 문제:**
- 투입 등록에서 EP 승인된 장비/인력이 표시되지 않음
- 반복적으로 같은 문제 발생

**근본 원인:**
- `entryRequestsV2.list` API가 items 배열을 반환하지 않음
- list는 items 개수만 조회하고, getById만 items를 포함

**해결:**
- ✅ `server/entry-request-router-v2.ts`: list API에서 items 배열 포함하도록 수정
- ✅ 반입 요청 선택 필드 제거 (자동 처리)
- ✅ EP 승인된 모든 장비/인력 자동 표시
- ✅ 장비 선택 시 해당 장비의 반입 요청 ID 자동 설정
- ✅ 운전자 선택 시 장비 선택 유지 (초기화 안 됨)

### ✅ 작업 확인서 문제 해결

**발견된 문제:**
- Worker 로그인 후 "투입된 현장이 없다"고 표시
- 실제로는 Deployment가 존재함

**근본 원인:**
- Deployment의 Worker는 송치봉(OZiZ6YvzB6a3d3nul2QJ8)인데 user_id가 null
- 로그인한 계정(shb@test.com)과 Worker의 user_id가 연결되지 않음

**해결:**
- ✅ 송치봉 Worker에 user_id 연결 (`vTlN5l45q9hl-0QQvCC_g`)
- ✅ `server/db.ts`: getDeploymentsByUserId에 디버깅 로그 추가

### ✅ 작업 확인서 월별 정리표 추가

**요구사항:**
- BP에서 승인 완료된 작업을 월별로 정리해서 볼 수 있어야 함
- 임대사업자별, 차량별, 운전자별 필터링
- 월별 조회 (예: 9/25 ~ 10/25)

**구현 내용:**
- ✅ `client/src/pages/WorkJournal.tsx`: 일별 목록 / 월별 정리표 탭 추가
- ✅ 월 선택기 (YYYY-MM 형식)
- ✅ Deployment별로 그룹화하여 카드 형식으로 표시:
  - 공사명, 장비번호/규격, 운전자명
  - 날짜별 작업내용, 조출, 점심OT, 연장, 철야, 확인(BP 승인)
  - 총 작업일, 총 연장, 총 철야, 승인 완료 비율
- ✅ `server/work-journal-router.ts`: BP용 월별 리포트 API 추가
- ✅ Owner/EP API도 Deployment별 그룹화 형식으로 수정

**테스트 완료:**
- ✅ BP 로그인 → 작업 확인서 승인 → 월별 정리표 탭
- ✅ Owner별 필터링 작동
- ✅ 월 선택 시 해당 월 데이터 조회

**관련 파일:**
- `client/src/components/EntryRequestDetail.tsx`
- `client/src/pages/Deployments.tsx`
- `client/src/pages/WorkJournal.tsx`
- `client/src/pages/mobile/SafetyInspectionNew.tsx`
- `server/entry-request-router-v2.ts`
- `server/work-journal-router.ts`
- `server/db.ts`

---

## 🎉 이전 완료 작업 (2025-11-05)

### ✅ Worker 이메일 로그인 시스템 완성

**문제 발견 및 해결:**
1. **Worker 로그인 불가 문제**
   - 원인: 비밀번호를 평문으로 저장하여 해시 비교 실패
   - 해결: `upsertUser` 함수에 SHA-256 해싱 추가 ✅

2. **Worker 수정 시 기존 내용 안 보임**
   - 원인: Workers 테이블에 email 컬럼이 없음
   - 해결: MCP로 `ALTER TABLE workers ADD COLUMN email TEXT` 실행 ✅

3. **db.createUser 함수 없음**
   - 원인: 함수가 정의되지 않음
   - 해결: `upsertUser`의 별칭으로 `createUser` 추가 ✅

**구현 내용:**
- ✅ `server/db.ts`: 비밀번호 해싱 추가
- ✅ `server/routers.ts`: Worker 생성 시 Users 테이블에 계정 자동 생성
- ✅ `server/routers.ts`: Worker 수정 시 email, password 변경 지원
- ✅ `client/src/pages/Workers.tsx`: email, password 입력 필드 추가
- ✅ DB 마이그레이션: workers 테이블에 email 컬럼 추가
- ✅ **로그인 테스트 성공!** 🎊

**테스트 완료:**
- ✅ Admin에서 Worker 등록 (email + password)
- ✅ 등록된 Worker 계정으로 모바일 로그인 성공
- ✅ Worker 목록에 email 표시

**관련 문서:**
- `docs/fix-worker-login-issue.md` - 전체 수정 내용
- `docs/worker-email-login-complete.md` - 최종 구현 가이드

---

## 🚀 시작하기 전에 읽어야 할 것

### 필수 문서
1. `CLAUDE.md` - 프로젝트 아키텍처 및 개발 가이드 (가장 중요!)
2. `최종완성보고서.md` - 완료된 기능 전체 목록
3. `모바일작업완료보고서.md` - 모바일 기능 완성 보고서
4. `README_반입요청개선.md` - 반입 요청 개선 사항

### Supabase MCP 사용 가이드

**MCP 연결 상태**: ✅ 연결됨  
**조직**: esms (bnreqwqoxhacnvaidvtw)  
**활성 프로젝트**: erms (zlgehckxiuhjpfjlaycf) - ap-south-1 리전

**MCP로 할 수 있는 작업들**:
- ✅ 프로젝트 조회 및 관리 (`mcp_supabase_list_projects`, `mcp_supabase_get_project`)
- ✅ 데이터베이스 테이블 조회 (`mcp_supabase_list_tables`)
- ✅ SQL 실행 (`mcp_supabase_execute_sql`)
- ✅ 마이그레이션 적용 (`mcp_supabase_apply_migration`)
- ✅ TypeScript 타입 생성 (`mcp_supabase_generate_typescript_types`)
- ✅ Edge Functions 관리 (`mcp_supabase_list_edge_functions`, `mcp_supabase_deploy_edge_function`)
- ✅ 로그 조회 (`mcp_supabase_get_logs`)
- ✅ 보안/성능 권고사항 확인 (`mcp_supabase_get_advisors`)
- ✅ 문서 검색 (`mcp_supabase_search_docs`)

**중요**: 데이터베이스 작업 시 MCP 도구를 우선적으로 사용하세요!
중요= context7 mcp 를 이용하여 최신업데이트 코드문서를 확인해
---

## 📊 현재 프로젝트 상태

### ✅ 완료된 주요 기능 (구현 완료 - 테스트 진행 중)

#### Phase 1-3: 기본 시스템
- ✅ 회사 관리 (Owner/BP/EP)
- ✅ 사용자 관리 (Admin/Owner/BP/EP/Worker/Inspector)
- ✅ 장비 관리 (등록, 서류 업로드, 상태 관리)
- ✅ 인력 관리 (등록, 서류 업로드, 상태 관리)
- ✅ 서류 관리 (통합 조회, 승인/반려, Supabase Storage 연동)
- ✅ **반입 요청 관리** (3단계 승인 프로세스) - **구현 완료, 테스트 필요**
- ✅ **투입 관리 및 작업확인서** - **구현 완료, 테스트 필요**
- ✅ **안전점검 시스템** - **구현 완료, 테스트 필요**

#### Phase 4: GPS 위치 추적 및 긴급 상황 대응
- ✅ GPS 위치 추적 (5분 간격)
- ✅ 실시간 위치 지도 (Google Maps)
- ✅ 긴급 알림 시스템
- ✅ 긴급 알림 목록 페이지

#### Phase 5: 작업 현황 모니터링
- ✅ 작업 현황 모니터링 페이지
- ✅ 경과 시간 실시간 계산
- ✅ 휴식 시간 준수 체크 (4시간 이상 경고)
- ✅ 통계 대시보드

#### 모바일 최적화
- ✅ Worker 앱 (작업 시작/종료, 휴식, 긴급 버튼)
- ✅ Inspector 앱 (안전점검)
- ✅ PIN 로그인 (4자리)
- ✅ 서류 촬영 및 업로드
- ✅ 점검 일지, 작업 일지

---

## 🧪 현재 단계: 테스트 및 개선

### 진행 상황
- **작업 확인서**: ✅ 구현 완료
- **반입 절차**: ✅ 구현 완료
- **안전확인서 작성**: ✅ 구현 완료
- **다음**: 테스트 → 에러 수정 → UI 개선 → 권한 체크

---

## 🎯 다음 작업 계획 (2025-11-06 시작 예정)

### 📋 역할별 기능 테스트 및 UI 개선

**목표**: 각 역할(Owner, BP, EP, Admin, Worker, Inspector)로 로그인하여 실제 사용 시나리오를 테스트하고, 발견된 UI/UX 문제를 즉시 개선합니다.

**작업 순서:**

#### 1단계: 테스트 계정 생성 및 확인
- [ ] Admin 계정 로그인 확인
- [ ] Owner 계정 생성/확인
- [ ] BP 계정 생성/확인
- [ ] EP 계정 생성/확인
- [ ] Worker 계정 생성/확인 (✅ 오늘 완료)
- [ ] Inspector 계정 생성/확인

#### 2단계: Owner 역할 테스트 🏢
- [ ] 로그인 테스트
- [ ] 대시보드 확인
- [ ] 장비 등록/수정/삭제
- [ ] 인력 등록/수정/삭제
- [ ] 서류 업로드
- [ ] 반입 요청 생성
- [ ] 작업 확인서 생성
- **UI 개선 목록 기록**

#### 3단계: BP 역할 테스트 👷
- [ ] 로그인 테스트
- [ ] 대시보드 확인 (승인 대기 목록 표시 확인)
- [ ] 반입 요청 승인/반려
- [ ] 작업 확인서 승인/반려
- [ ] 서류 조회 (할당된 것만)
- **UI 개선 목록 기록**

#### 4단계: EP 역할 테스트 👔
- [ ] 로그인 테스트
- [ ] 대시보드 확인 (최종 승인 대기 목록 표시)
- [ ] 반입 요청 최종 승인/반려
- [ ] 작업 확인서 최종 승인
- [ ] 통계 조회
- **UI 개선 목록 기록**

#### 5단계: Admin 역할 테스트 🔧
- [ ] 전체 데이터 조회 권한 확인
- [ ] 회사 관리
- [ ] 사용자 관리
- [ ] 서류 타입 관리
- [ ] 점검 템플릿 관리
- [ ] 통계 대시보드
- **UI 개선 목록 기록**

#### 6단계: Worker 모바일 테스트 📱
- [ ] 모바일 로그인 (✅ 오늘 완료)
- [ ] 작업 시작/종료
- [ ] 휴식 기능
- [ ] 긴급 알림
- [ ] 내 정보 (서류 업로드)
- [ ] 반응형 디자인 확인
- **UI 개선 목록 기록**

#### 7단계: Inspector 모바일 테스트 🔍
- [ ] 모바일 로그인
- [ ] 안전점검 수행
- [ ] 점검 항목 체크
- [ ] 사진 촬영 및 업로드
- [ ] 전자 서명
- [ ] 점검 완료 제출
- **UI 개선 목록 기록**

#### 8단계: End-to-End 시나리오 테스트 🔄
- [ ] **반입 절차 전체 워크플로우**
  - Owner: 반입 요청 생성
  - BP: 승인
  - Owner: 검토 및 승인
  - EP: 최종 승인
  - 알림 전송 확인
  
- [ ] **작업 확인서 전체 워크플로우**
  - Owner: 작업 확인서 작성
  - BP: 승인
  - EP: 최종 승인
  - 알림 전송 확인
  
- [ ] **안전점검 전체 워크플로우**
  - Inspector: 점검 수행
  - Admin: 결과 확인
  - 불합격 시 조치

#### 9단계: UI/UX 개선 우선순위 정리
- [ ] 발견된 모든 UI 이슈 취합
- [ ] 우선순위 분류 (높음/중간/낮음)
- [ ] 빠른 수정 항목 즉시 처리
- [ ] 큰 개선 항목 계획 수립

#### 10단계: 문서 업데이트
- [ ] 발견된 버그 목록 작성
- [ ] UI 개선 목록 작성
- [ ] 테스트 결과 요약
- [ ] 다음 우선순위 결정

---

## 🎯 우선순위 0: 테스트 및 개선 체크리스트 (현재 진행 중)

### A. 작업 확인서 테스트 📋

#### 기능 테스트
- [ ] **작업 확인서 생성**
  - [ ] Owner: 작업 확인서 작성 페이지 접근
  - [ ] 장비 선택 (드롭다운)
  - [ ] 인력 선택 (드롭다운)
  - [ ] 작업 일자 선택
  - [ ] 작업 시간 입력 (시작/종료)
  - [ ] 작업 유형 선택 (일대/월대/O/T/철야)
  - [ ] 작업 내용 입력
  - [ ] 전자 서명 (Canvas)
  - [ ] 제출 성공 확인

- [ ] **작업 확인서 조회**
  - [ ] Owner: 내가 제출한 작업 확인서 목록 조회
  - [ ] BP: 승인 대기 중인 작업 확인서 목록 조회
  - [ ] EP: 최종 승인 대기 중인 작업 확인서 목록 조회
  - [ ] 상태별 필터링 (대기/승인/반려)
  - [ ] 날짜별 필터링
  - [ ] 상세 정보 모달 표시

- [ ] **작업 확인서 승인/반려 (BP)**
  - [ ] BP: 승인 버튼 클릭
  - [ ] BP 전자 서명 입력
  - [ ] 승인 완료 확인
  - [ ] BP: 반려 버튼 클릭
  - [ ] 반려 사유 입력
  - [ ] 반려 완료 확인
  - [ ] Owner에게 알림 전송 확인

- [ ] **작업 확인서 최종 승인 (EP)**
  - [ ] EP: BP 승인 완료된 작업 확인서 조회
  - [ ] EP: 최종 승인 버튼 클릭
  - [ ] 승인 완료 확인
  - [ ] Owner/BP에게 알림 전송 확인

#### 권한 테스트
- [ ] **Owner 권한**
  - [ ] 작업 확인서 생성 가능
  - [ ] 자신의 작업 확인서만 조회 가능
  - [ ] 타인의 작업 확인서 수정 불가
- [ ] **BP 권한**
  - [ ] 할당된 작업 확인서만 승인/반려 가능
  - [ ] 타 BP의 작업 확인서 접근 불가
- [ ] **EP 권한**
  - [ ] BP 승인 완료된 작업 확인서만 최종 승인 가능
  - [ ] 타 EP의 작업 확인서 접근 불가
- [ ] **Admin 권한**
  - [ ] 모든 작업 확인서 조회 가능
  - [ ] 통계 조회 가능
- [ ] **Worker/Inspector 권한**
  - [ ] 작업 확인서 생성/조회/승인 불가 (권한 없음)

#### UI/UX 개선 체크
- [ ] **모바일 반응형**
  - [ ] 스마트폰 화면에서 레이아웃 확인
  - [ ] 터치 영역 크기 적절 (최소 44x44px)
  - [ ] 입력 필드 iOS 줌 방지 (font-size 16px 이상)
- [ ] **로딩 상태**
  - [ ] 작업 확인서 제출 시 로딩 인디케이터 표시
  - [ ] 승인/반려 처리 시 로딩 인디케이터 표시
- [ ] **에러 메시지**
  - [ ] 필수 입력 항목 누락 시 명확한 에러 메시지
  - [ ] 네트워크 에러 시 재시도 안내
  - [ ] 권한 에러 시 명확한 안내
- [ ] **성공 메시지**
  - [ ] 작업 확인서 제출 성공 시 Toast 메시지
  - [ ] 승인/반려 완료 시 Toast 메시지

#### 에러 케이스 테스트
- [ ] 필수 입력 항목 누락
- [ ] 잘못된 시간 범위 (종료 시간 < 시작 시간)
- [ ] 서명 누락
- [ ] 네트워크 에러 (오프라인)
- [ ] 권한 없는 사용자 접근
- [ ] 중복 제출 방지

---

### B. 반입 절차 테스트 🚚

#### 기능 테스트
- [ ] **반입 요청 생성 (Owner)**
  - [ ] 반입 요청 작성 페이지 접근
  - [ ] 장비 선택 (다중 선택 가능)
  - [ ] 인력 선택 (다중 선택 가능)
  - [ ] 반입 일자 선택
  - [ ] 작업 내용 입력
  - [ ] BP/EP 선택
  - [ ] 서류 자동 검증 확인 (필수 서류 체크)
  - [ ] 제출 성공 확인

- [ ] **반입 요청 조회**
  - [ ] Owner: 내가 제출한 반입 요청 목록
  - [ ] BP: 승인 대기 중인 반입 요청 목록
  - [ ] EP: 최종 승인 대기 중인 반입 요청 목록
  - [ ] 상태별 필터링
  - [ ] 날짜별 필터링
  - [ ] 상세 정보 모달 표시 (장비/인력 목록)

- [ ] **BP 승인 단계**
  - [ ] BP: 반입 요청 상세 조회
  - [ ] 장비/인력 서류 확인
  - [ ] 작업 계획서 업로드
  - [ ] 전자 서명
  - [ ] 승인 버튼 클릭
  - [ ] 승인 완료 확인
  - [ ] Owner에게 알림 전송

- [ ] **Owner 검토 단계**
  - [ ] Owner: BP 승인된 반입 요청 조회
  - [ ] 작업 계획서 확인
  - [ ] 승인 또는 수정 요청
  - [ ] 수정 요청 시 BP에게 알림

- [ ] **EP 최종 승인 단계**
  - [ ] EP: Owner 승인 완료된 반입 요청 조회
  - [ ] 모든 서류 검토
  - [ ] 전자 서명
  - [ ] 최종 승인 버튼 클릭
  - [ ] 승인 완료 확인
  - [ ] Owner/BP에게 알림 전송

- [ ] **반입 요청 반려**
  - [ ] BP/Owner/EP: 반려 버튼 클릭
  - [ ] 반려 사유 입력
  - [ ] 반려 완료 확인
  - [ ] 관련자에게 알림 전송

#### 권한 테스트
- [ ] **Owner 권한**
  - [ ] 반입 요청 생성 가능
  - [ ] 자신의 장비/인력만 선택 가능
  - [ ] 자신의 반입 요청만 조회 가능
- [ ] **BP 권한**
  - [ ] 할당된 반입 요청만 승인/반려 가능
  - [ ] 타 BP의 반입 요청 접근 불가
  - [ ] 작업 계획서 업로드 가능
- [ ] **EP 권한**
  - [ ] Owner 승인 완료된 반입 요청만 최종 승인 가능
  - [ ] 타 EP의 반입 요청 접근 불가
- [ ] **Admin 권한**
  - [ ] 모든 반입 요청 조회 가능
  - [ ] 통계 조회 가능
- [ ] **Worker/Inspector 권한**
  - [ ] 반입 요청 생성/조회/승인 불가

#### UI/UX 개선 체크
- [ ] **서류 검증 UI**
  - [ ] 필수 서류 미등록 시 빨간색 경고 표시
  - [ ] 서류 만료 시 노란색 경고 표시
  - [ ] 서류 정상 시 녹색 체크 표시
- [ ] **워크플로우 시각화**
  - [ ] 현재 단계 표시 (Progress Bar)
  - [ ] 다음 승인자 표시
  - [ ] 승인 이력 타임라인
- [ ] **모바일 반응형**
  - [ ] 스마트폰 화면에서 레이아웃 확인
  - [ ] 다중 선택 UI 모바일 최적화
- [ ] **로딩 상태**
  - [ ] 서류 검증 시 로딩 표시
  - [ ] 제출 시 로딩 인디케이터
- [ ] **에러/성공 메시지**
  - [ ] 명확한 에러 메시지
  - [ ] Toast 알림

#### 에러 케이스 테스트
- [ ] 필수 서류 미등록 상태로 제출 시도
- [ ] 만료된 서류가 있는 상태로 제출 시도
- [ ] 장비/인력 미선택 상태로 제출
- [ ] BP/EP 미선택 상태로 제출
- [ ] 네트워크 에러
- [ ] 권한 없는 사용자 접근
- [ ] 중복 제출 방지

#### 3단계 워크플로우 통합 테스트
- [ ] **End-to-End 테스트**
  - [ ] Owner: 반입 요청 생성 → 제출
  - [ ] BP: 승인 또는 반려
  - [ ] Owner: BP 승인 내용 확인 → 승인
  - [ ] EP: 최종 승인 또는 반려
  - [ ] Owner: 최종 승인 완료 확인
  - [ ] 알림 전송 확인 (각 단계마다)

---

### C. 안전확인서 작성 테스트 🔍

#### 기능 테스트
- [ ] **안전점검 시작 (Inspector)**
  - [ ] Inspector 모바일 앱 접근
  - [ ] PIN 로그인
  - [ ] 장비 선택
  - [ ] 점검 템플릿 선택
  - [ ] 점검 항목 체크리스트 표시

- [ ] **점검 항목 작성**
  - [ ] 각 항목별 합격/불합격 체크
  - [ ] 특이사항 입력
  - [ ] 사진 촬영 및 업로드
  - [ ] 진행률 표시
  - [ ] 임시 저장 기능

- [ ] **점검 완료 및 제출**
  - [ ] Inspector 전자 서명
  - [ ] 점검 완료 제출
  - [ ] 제출 성공 확인
  - [ ] Owner/Admin에게 알림 전송

- [ ] **안전점검 결과 조회**
  - [ ] Admin: 모든 안전점검 결과 조회
  - [ ] Owner: 내 장비 안전점검 결과 조회
  - [ ] 상태별 필터링 (합격/불합격/임시저장)
  - [ ] 날짜별 필터링
  - [ ] 상세 정보 모달 (점검 항목별 결과)

- [ ] **불합격 처리**
  - [ ] Admin: 불합격 장비 조치 완료 처리
  - [ ] 조치 내용 입력
  - [ ] 재점검 요청
  - [ ] Owner에게 알림 전송

#### 권한 테스트
- [ ] **Inspector 권한**
  - [ ] 안전점검 수행 가능
  - [ ] 전자 서명 가능
  - [ ] 점검 결과 제출 가능
- [ ] **Owner 권한**
  - [ ] 자신의 장비 점검 결과만 조회 가능
  - [ ] 점검 수행 불가
- [ ] **Admin 권한**
  - [ ] 모든 점검 결과 조회 가능
  - [ ] 불합격 처리 및 조치 가능
  - [ ] 점검 템플릿 관리 가능
- [ ] **BP/EP/Worker 권한**
  - [ ] 안전점검 관련 기능 접근 불가

#### UI/UX 개선 체크
- [ ] **모바일 최적화**
  - [ ] 점검 항목 체크박스 크기 적절
  - [ ] 카메라 연동 원활
  - [ ] 서명 Canvas 크기 적절
- [ ] **진행률 표시**
  - [ ] Progress Bar 실시간 업데이트
  - [ ] 완료/미완료 항목 수 표시
- [ ] **임시 저장**
  - [ ] 임시 저장 버튼 눈에 잘 띄는 위치
  - [ ] 임시 저장 성공 시 Toast 메시지
  - [ ] 임시 저장된 점검 이어하기 기능
- [ ] **로딩 상태**
  - [ ] 사진 업로드 시 로딩 표시
  - [ ] 제출 시 로딩 인디케이터
- [ ] **에러/성공 메시지**
  - [ ] 명확한 에러 메시지
  - [ ] 제출 성공 Toast 메시지

#### 에러 케이스 테스트
- [ ] 필수 항목 미작성 상태로 제출 시도
- [ ] 서명 누락 상태로 제출
- [ ] 사진 업로드 실패
- [ ] 네트워크 에러 (임시 저장 동작 확인)
- [ ] 권한 없는 사용자 접근
- [ ] 중복 제출 방지

---

### D. 통합 테스트 및 성능 체크 ⚡

#### 데이터 무결성 테스트
- [ ] **외래 키 제약 조건**
  - [ ] 존재하지 않는 장비 ID로 작업 확인서 생성 시도
  - [ ] 존재하지 않는 인력 ID로 반입 요청 생성 시도
  - [ ] 삭제된 장비에 대한 안전점검 시도
- [ ] **중복 방지**
  - [ ] 동일 장비/인력/날짜로 중복 작업 확인서 생성 방지
  - [ ] 동일 반입 요청 중복 제출 방지
- [ ] **상태 전이 검증**
  - [ ] 잘못된 상태 전이 차단 (예: bp_requested → ep_approved 직접 전이 차단)

#### 성능 테스트
- [ ] **페이지 로딩 속도**
  - [ ] 초기 로딩 3초 이내
  - [ ] 목록 조회 1초 이내
  - [ ] 상세 조회 0.5초 이내
- [ ] **대량 데이터 처리**
  - [ ] 100개 이상의 작업 확인서 목록 조회 성능
  - [ ] 50개 이상의 반입 요청 목록 조회 성능
- [ ] **파일 업로드**
  - [ ] 5MB 이미지 업로드 속도 확인
  - [ ] 10MB PDF 업로드 속도 확인
  - [ ] 다중 파일 업로드 (10개) 성능 확인

#### 크로스 브라우저 테스트
- [ ] Chrome (최신)
- [ ] Safari (iOS)
- [ ] Edge
- [ ] Firefox

#### 모바일 디바이스 테스트
- [ ] iOS (Safari)
- [ ] Android (Chrome)
- [ ] 다양한 화면 크기 (iPhone SE ~ iPad)

---

### E. 에러 수집 및 수정 🐛

#### 발견된 에러 목록
*테스트 진행하면서 발견된 에러를 여기에 기록*

- [ ] 에러 1: (설명)
  - 재현 방법:
  - 예상 원인:
  - 수정 계획:
  - 수정 완료: ⬜

- [ ] 에러 2: (설명)
  - 재현 방법:
  - 예상 원인:
  - 수정 계획:
  - 수정 완료: ⬜

---

### F. UI 개선 목록 🎨

#### 발견된 UI 개선사항
*테스트 진행하면서 발견된 UI 개선사항을 여기에 기록*

- [ ] UI 개선 1: (설명)
  - 현재 상태:
  - 개선 방안:
  - 우선순위: (높음/중간/낮음)
  - 개선 완료: ⬜

- [ ] UI 개선 2: (설명)
  - 현재 상태:
  - 개선 방안:
  - 우선순위: (높음/중간/낮음)
  - 개선 완료: ⬜

---

### G. 권한 체크 매트릭스 🔐

#### 역할별 기능 접근 권한 확인

| 기능 | Admin | Owner | BP | EP | Worker | Inspector |
|------|-------|-------|----|----|--------|-----------|
| **작업 확인서 생성** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **작업 확인서 조회 (전체)** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **작업 확인서 조회 (본인)** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **작업 확인서 승인 (BP)** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **작업 확인서 최종 승인 (EP)** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **반입 요청 생성** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **반입 요청 조회 (전체)** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **반입 요청 조회 (본인)** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **반입 요청 BP 승인** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **반입 요청 Owner 승인** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **반입 요청 EP 최종 승인** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **안전점검 수행** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **안전점검 결과 조회 (전체)** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **안전점검 결과 조회 (본인 장비)** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **불합격 처리 및 조치** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| **점검 템플릿 관리** | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |

**범례**:
- ✅ = 정상 작동 확인
- ❌ = 권한 없음 (정상 차단 확인)
- ⬜ = 미테스트
- 🐛 = 에러 발견

---

## 🔴 우선순위 1: 긴급 수정 사항 (테스트 후 발견된 이슈)

### 1. 반입 요청 검증 에러 수정 ✅ (완료됨)
- **상태**: 완료 (Oct 27, 2025)
- **파일**: `add-owner-requested-status.sql` 적용 완료
- **내용**: `owner_requested` enum 값 추가

### 2. 무한 로딩 문제 해결 🔄 (진행 필요)
- **증상**: 프론트엔드 빌드 후 일부 페이지에서 무한 로딩
- **원인**: 파악 필요
- **조치**:
  - [ ] 빌드 최적화 확인
  - [ ] 코드 스플리팅 개선
  - [ ] React Query 캐싱 전략 검토
  - [ ] 초기 로딩 속도 프로파일링

---

## 🟠 우선순위 2: 데이터베이스 및 백엔드

### 1. RLS (Row Level Security) 활성화 🔄 (중요!)
- **현재 상태**: DISABLED
- **위험도**: 높음 (프로덕션 배포 전 필수)
- **조치**:
  - [ ] MCP로 현재 RLS 정책 확인
  - [ ] 역할별 RLS 정책 설계
  - [ ] 테스트 환경에서 RLS 정책 적용
  - [ ] 전체 기능 테스트 (권한 확인)
  - [ ] 프로덕션 적용

**MCP 명령어 예시**:
```typescript
// 현재 RLS 상태 확인
mcp_supabase_execute_sql({
  project_id: "zlgehckxiuhjpfjlaycf",
  query: "SELECT schemaname, tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public';"
})
```

### 2. 데이터 무결성 제약 조건 추가
- **목적**: 중복 투입 방지, 비즈니스 룰 강제
- **조치**:
  - [ ] 하나의 Worker는 한 번에 하나의 활성 Deployment만 가능
  - [ ] 하나의 Equipment는 한 번에 하나의 활성 Deployment만 가능
  - [ ] Deployment start_date는 entry request의 requested_start_date 이후여야 함
  - [ ] 데이터베이스 제약 조건 또는 트리거로 구현

### 3. 서류 만료 스케줄러 구현
- **파일**: `server/_core/scheduler.ts`
- **조치**:
  - [ ] node-cron 설치
  - [ ] 매일 오전 9시 실행 스케줄러 구현
  - [ ] 30일, 7일, 당일 만료 예정 서류 체크
  - [ ] 이메일 알림 발송 (SendGrid 또는 AWS SES)
  - [ ] 서버 시작 시 스케줄러 초기화

---

## 🟡 우선순위 3: 프론트엔드 개선

### 1. 역할별 대시보드 커스터마이징 🔄 (부분 완료)
- **현재 상태**: 기본 대시보드 존재
- **개선 필요**:
  - [ ] Admin 대시보드 강화 (시스템 전체 통계)
  - [ ] Owner 대시보드 강화 (내 장비/인력 현황)
  - [ ] BP/EP 대시보드 강화 (승인 대기 목록)
  - [ ] Worker 대시보드 간소화 (모바일 중심)

### 2. 통계 및 리포트 기능 강화
- **현재 상태**: 기본 통계 있음
- **개선 필요**:
  - [ ] 장비 가동률 차트
  - [ ] 인력 투입 현황 차트
  - [ ] 서류 만료 통계
  - [ ] 안전점검 합격률 트렌드
  - [ ] Excel 다운로드 (xlsx 라이브러리)
  - [ ] PDF 다운로드 (jsPDF 라이브러리)

### 3. 실시간 알림 시스템
- **목표**: WebSocket 또는 Push Notification
- **조치**:
  - [ ] 긴급 알림 실시간 푸시
  - [ ] 휴식 필요 알림
  - [ ] 승인 요청 알림
  - [ ] 서류 만료 임박 알림
  - [ ] Socket.io 또는 Supabase Realtime 사용

---

## 🟢 우선순위 4: 개발 경험 및 품질

### 1. 타입 안전성 개선
- [ ] `ChecklistForms.tsx`의 타입 경고 해결
- [ ] 전역 타입 정의 파일 생성 (`types/index.ts`)
- [ ] `any` 타입 제거
- [ ] tRPC 타입 재생성 확인

### 2. 에러 처리 개선
- [ ] 전역 에러 바운더리 강화
- [ ] API 에러 메시지 표준화
- [ ] 사용자 친화적인 에러 메시지
- [ ] 에러 로깅 (Sentry 또는 LogRocket)

### 3. 성능 최적화
- [ ] React Query 캐싱 전략 개선
- [ ] 이미지 lazy loading
- [ ] 코드 스플리팅 (React.lazy)
- [ ] 번들 사이즈 분석 (vite-bundle-visualizer)

### 4. 테스트 코드 작성
- [ ] 단위 테스트 (Vitest) - 주요 유틸리티 함수
- [ ] API 테스트 (tRPC router 테스트)
- [ ] E2E 테스트 (Playwright) - 주요 워크플로우
  - 반입 요청 생성 → BP 승인 → EP 승인
  - 장비 등록 → 서류 업로드 → 승인
  - Worker 작업 시작 → 휴식 → 작업 종료

---

## 🔵 우선순위 5: 프로덕션 준비

### 1. 환경 변수 관리
- [ ] 프로덕션 환경 변수 분리
- [ ] Vercel 환경 변수 설정
- [ ] 시크릿 키 로테이션 계획

### 2. 파일 저장소 (Supabase Storage)
- [ ] Storage 버킷 정책 설정
- [ ] 파일 크기 제한 적용 (이미지: 5MB, PDF: 10MB)
- [ ] 파일 형식 제한 (jpg, png, pdf만 허용)
- [ ] 파일 삭제 시 Storage에서도 삭제 (현재는 DB에서만 삭제됨)
- [ ] 원본 파일명으로 다운로드 기능

### 3. 보안 강화
- [ ] JWT_SECRET 강력한 랜덤 문자열로 변경
- [ ] CORS 설정 검토
- [ ] Rate Limiting 추가 (express-rate-limit)
- [ ] SQL Injection 방지 확인 (Drizzle ORM 사용 중이므로 안전)
- [ ] XSS 방지 확인

### 4. 모니터링 및 로깅
- [ ] MCP로 Supabase 로그 주기적으로 확인
- [ ] 에러 로깅 시스템 구축
- [ ] 성능 모니터링 (Vercel Analytics)
- [ ] 데이터베이스 쿼리 성능 모니터링

**MCP 명령어 예시**:
```typescript
// API 로그 확인
mcp_supabase_get_logs({
  project_id: "zlgehckxiuhjpfjlaycf",
  service: "api"
})

// 보안 권고사항 확인
mcp_supabase_get_advisors({
  project_id: "zlgehckxiuhjpfjlaycf",
  type: "security"
})

// 성능 권고사항 확인
mcp_supabase_get_advisors({
  project_id: "zlgehckxiuhjpfjlaycf",
  type: "performance"
})
```

### 5. 배포 및 CI/CD
- [ ] Vercel 배포 설정 (`VERCEL_DEPLOYMENT.md` 참고)
- [ ] GitHub Actions CI/CD 파이프라인
- [ ] 자동 빌드 및 테스트
- [ ] 프로덕션 배포 전 스테이징 환경 테스트

---

## 🎨 선택적 개선 사항 (Nice to Have)

### 1. PWA (Progressive Web App) 지원
- [ ] Service Worker 추가
- [ ] 오프라인 모드 (IndexedDB 캐싱)
- [ ] 홈 화면에 추가 기능
- [ ] Web Push Notification

### 2. 모바일 기능 강화
- [ ] 풀 투 리프레시 (Pull to Refresh)
- [ ] 스와이프 제스처
- [ ] 생체 인증 (Face ID / Touch ID)
- [ ] QR 코드 스캔 (장비 정보 자동 입력)
- [ ] 음성 입력 (Web Speech API)

### 3. 국제화 (i18n)
- [ ] 다국어 지원 (한국어, 영어)
- [ ] react-i18next 설치
- [ ] 번역 파일 작성

### 4. 문서화
- [ ] API 문서 자동 생성 (tRPC openapi)
- [ ] 컴포넌트 Storybook
- [ ] 사용자 매뉴얼

---

## 🐛 알려진 이슈

### 1. Case Sensitivity in Roles ⚠️
- **문제**: 역할 비교 시 대소문자 불일치
- **해결책**: 항상 `.toLowerCase()` 사용
- **예시**: `if (ctx.user.role?.toLowerCase() !== "admin")`

### 2. 무한 로딩 문제 ⚠️
- **증상**: 일부 페이지에서 무한 로딩
- **조사 필요**: 빌드 최적화, React Query 설정

### 3. 파일 삭제 시 Storage 미삭제 ⚠️
- **문제**: DB에서만 삭제되고 Supabase Storage에서는 남아있음
- **해결책**: 삭제 API에서 Storage 파일도 함께 삭제

---

## 📚 주요 명령어

### 개발
```bash
pnpm dev              # 개발 서버 시작 (포트 3000, 3001, ...)
pnpm build            # 프로덕션 빌드
pnpm start            # 프로덕션 서버 실행
pnpm check            # TypeScript 타입 체크
pnpm format           # Prettier 포맷팅
pnpm test             # Vitest 테스트
```

### 데이터베이스
```bash
pnpm db:push          # 마이그레이션 생성 및 적용
```

### Supabase MCP (AI Assistant 사용)
- 테이블 조회: `mcp_supabase_list_tables`
- SQL 실행: `mcp_supabase_execute_sql`
- 마이그레이션: `mcp_supabase_apply_migration`
- TypeScript 타입: `mcp_supabase_generate_typescript_types`
- 로그 확인: `mcp_supabase_get_logs`
- 보안 체크: `mcp_supabase_get_advisors`

---

## 🔗 중요 링크

### 문서
- [프로젝트 아키텍처](./CLAUDE.md)
- [완성 보고서](./최종완성보고서.md)
- [작업 가이드](./다음작업가이드.md)
- [배포 가이드](./DEPLOYMENT.md)

### 외부 문서
- [tRPC](https://trpc.io/)
- [Drizzle ORM](https://orm.drizzle.team/)
- [Supabase](https://supabase.com/docs)
- [shadcn/ui](https://ui.shadcn.com/)

---

## 💡 다음 작업 시작 방법

1. **이 파일(`todos.md`)을 먼저 읽기**
2. **`CLAUDE.md` 읽기** - 아키텍처 이해
3. **우선순위 1부터 작업 시작**
4. **MCP 도구를 적극 활용** (데이터베이스, 로그, 보안 체크)
5. **작업 완료 시 이 파일 업데이트**

---

## 📝 작업 요약

### 오늘 완료 (2025-11-07)
- ✅ 반입 요청 전체 보기 기능 (PDF 브라우저에서 직접 보기)
- ✅ EP 승인 화면 버튼 크기 조정
- ✅ 투입 관리 근본 문제 해결 (entry_requests.list에 items 포함)
- ✅ Worker user_id 연결 문제 해결
- ✅ 작업 확인서 월별 정리표 추가 (BP/Owner/EP용)

### 이전 완료 (2025-11-05)
- ✅ Worker 이메일 로그인 시스템 완성
- ✅ 비밀번호 해싱 구현
- ✅ Workers 테이블에 email 컬럼 추가 (MCP)
- ✅ Worker 등록/수정 API 개선

### 다음 작업 계획
- 🎯 **작업 확인서 작성 및 승인 테스트** (Worker → BP → 월별 정리표)
- 🎯 **반입 요청 → 투입 등록 → 작업 확인서 전체 워크플로우 테스트**
- 🎨 **추가 UI/UX 개선** (사용자 피드백 반영)
- 📋 **모바일 Inspector 기능 테스트**

### 이후 우선순위
1. RLS (Row Level Security) 활성화
2. 성능 최적화
3. 보안 강화
4. 프로덕션 배포 준비

---

**마지막 업데이트**: 2025-11-07
**다음 작업**: 작업 확인서 및 월별 정리표 테스트
**Supabase MCP**: ✅ 연결됨 및 사용 가능
**오늘 작업 종료**: 오늘은 여기까지 작업 완료 🎉

