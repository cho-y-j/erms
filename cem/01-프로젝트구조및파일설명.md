# 건설장비 및 인력 관리 시스템 (ERMS) - 프로젝트 구조 및 파일 설명

**작성일**: 2025-10-26  
**버전**: 2.0  
**프로젝트명**: Equipment and Resource Management System (ERMS)

---

## 📁 프로젝트 디렉토리 구조

```
construction-equipment-management/
├── client/                          # 프론트엔드 (React + TypeScript)
│   ├── public/                      # 정적 파일
│   │   ├── icon-192.png            # PWA 아이콘
│   │   ├── icon-512.png
│   │   └── manifest.json           # PWA 매니페스트
│   │
│   └── src/                         # 소스 코드
│       ├── _core/                   # 핵심 기능
│       │   ├── hooks/              # React Hooks
│       │   │   └── useAuth.tsx     # 인증 Hook
│       │   └── lib/                # 유틸리티
│       │       └── trpc.ts         # tRPC 클라이언트 설정
│       │
│       ├── components/              # 공통 컴포넌트
│       │   ├── ui/                 # shadcn/ui 컴포넌트
│       │   │   ├── button.tsx
│       │   │   ├── card.tsx
│       │   │   ├── dialog.tsx
│       │   │   ├── input.tsx
│       │   │   ├── select.tsx
│       │   │   ├── table.tsx
│       │   │   └── ...
│       │   │
│       │   ├── DashboardLayout.tsx  # 대시보드 레이아웃
│       │   ├── DocumentStatusBadge.tsx  # 서류 상태 뱃지
│       │   └── GoogleMap.tsx        # 구글맵 컴포넌트
│       │
│       └── pages/                   # 페이지 컴포넌트
│           ├── Login.tsx            # 로그인 페이지
│           ├── Dashboard.tsx        # 대시보드
│           │
│           ├── Companies.tsx        # 회사 관리 (Admin)
│           ├── Users.tsx            # 사용자 관리 (Admin)
│           ├── EquipmentTypes.tsx   # 장비 유형 관리 (Admin)
│           ├── WorkerTypes.tsx      # 인력 유형 관리 (Admin)
│           │
│           ├── Equipment.tsx        # 장비 관리 (Owner)
│           ├── Workers.tsx          # 인력 관리 (Owner)
│           ├── Documents.tsx        # 서류 관리
│           │
│           ├── EntryRequestsNew.tsx # 반입 요청 (Owner → BP → EP)
│           ├── Deployments.tsx      # 투입 관리
│           ├── WorkConfirmation.tsx # 작업확인서
│           │
│           ├── LocationTracking.tsx # 실시간 위치 추적 ✨
│           ├── EmergencyAlerts.tsx  # 긴급 알림 목록 ✨
│           ├── WorkMonitoring.tsx   # 작업 현황 모니터링 ✨
│           │
│           └── mobile/              # 모바일 앱
│               ├── WorkerMain.tsx   # Worker 앱 메인
│               └── InspectorMain.tsx # Inspector 앱 메인
│
├── server/                          # 백엔드 (Node.js + TypeScript)
│   ├── _core/                       # 핵심 기능
│   │   ├── index.ts                # 서버 엔트리 포인트
│   │   ├── trpc.ts                 # tRPC 서버 설정
│   │   └── auth.ts                 # 인증 미들웨어
│   │
│   ├── db.ts                        # 데이터베이스 함수
│   ├── storage.ts                   # Supabase Storage 함수
│   │
│   ├── routers.ts                   # 메인 라우터 (모든 라우터 통합)
│   │
│   ├── companies-router.ts          # 회사 관리 API
│   ├── users-router.ts              # 사용자 관리 API
│   ├── equipment-types-router.ts    # 장비 유형 API
│   ├── worker-types-router.ts       # 인력 유형 API
│   │
│   ├── entry-request-router-v2.ts   # 반입 요청 API (V2)
│   ├── deployment-router.ts         # 투입 관리 API
│   ├── work-confirmation-router.ts  # 작업확인서 API
│   │
│   ├── location-router.ts           # GPS 위치 추적 API ✨
│   ├── emergency-router.ts          # 긴급 알림 API ✨
│   ├── mobile-router.ts             # 모바일 앱 API (Worker/Inspector)
│   │
│   └── system-router.ts             # 시스템 API
│
├── drizzle/                         # 데이터베이스 스키마
│   ├── schema.ts                    # Drizzle ORM 스키마
│   └── migrations/                  # 마이그레이션 파일
│       ├── 0001_create_tables.sql
│       ├── 0002_add_work_sessions.sql
│       └── ...
│
├── .env                             # 환경 변수
├── package.json                     # 프로젝트 의존성
├── tsconfig.json                    # TypeScript 설정
├── vite.config.ts                   # Vite 설정
└── README.md                        # 프로젝트 설명

```

---

## 🗂️ 주요 파일 설명

### 프론트엔드 (client/)

#### 1. 핵심 파일

| 파일 | 역할 | 설명 |
|------|------|------|
| `src/_core/hooks/useAuth.tsx` | 인증 Hook | 로그인 상태, 사용자 정보, 로그아웃 함수 제공 |
| `src/_core/lib/trpc.ts` | tRPC 클라이언트 | 백엔드 API 호출을 위한 타입 안전 클라이언트 |
| `src/components/DashboardLayout.tsx` | 레이아웃 | 대시보드 레이아웃 (메뉴, 헤더, 사이드바) |
| `src/components/GoogleMap.tsx` | 구글맵 | Google Maps API 래퍼 컴포넌트 |
| `src/pages/Login.tsx` | 로그인 | 이메일/비밀번호 또는 PIN 로그인 |

#### 2. 관리자 (Admin) 페이지

| 파일 | 역할 | 권한 |
|------|------|------|
| `src/pages/Companies.tsx` | 회사 관리 | Admin 전용 |
| `src/pages/Users.tsx` | 사용자 관리 | Admin 전용 |
| `src/pages/EquipmentTypes.tsx` | 장비 유형 관리 | Admin 전용 |
| `src/pages/WorkerTypes.tsx` | 인력 유형 관리 | Admin 전용 |

#### 3. Owner 페이지순 하

| 파일 | 역할 | 권한 |
|------|------|------|
| `src/pages/Equipment.tsx` | 장비 관리 | Owner |
| `src/pages/Workers.tsx` | 인력 관리 | Owner |
| `src/pages/EntryRequestsNew.tsx` | 반입 요청 | Owner → BP → EP |
| `src/pages/Deployments.tsx` | 투입 관리 | Owner |

#### 4. 공통 페이지

| 파일 | 역할 | 권한 |
|------|------|------|
| `src/pages/Documents.tsx` | 서류 관리 | All |
| `src/pages/WorkConfirmation.tsx` | 작업확인서 | Owner, BP |
| `src/pages/LocationTracking.tsx` | 실시간 위치 추적 ✨ | Admin, Owner |
| `src/pages/EmergencyAlerts.tsx` | 긴급 알림 목록 ✨ | Admin, Owner |
| `src/pages/WorkMonitoring.tsx` | 작업 현황 모니터링 ✨ | Admin, Owner |

#### 5. 모바일 앱 페이지

| 파일 | 역할 | 권한 |
|------|------|------|
| `src/pages/mobile/WorkerMain.tsx` | Worker 앱 | Worker |
| `src/pages/mobile/InspectorMain.tsx` | Inspector 앱 | Inspector (미사용) |

---

### 백엔드 (server/)

#### 1. 핵심 파일

| 파일 | 역할 | 설명 |
|------|------|------|
| `_core/index.ts` | 서버 엔트리 | Express 서버 시작, tRPC 설정 |
| `_core/trpc.ts` | tRPC 설정 | 라우터, 프로시저, 컨텍스트 정의 |
| `_core/auth.ts` | 인증 미들웨어 | JWT 토큰 검증, 사용자 정보 추출 |
| `db.ts` | 데이터베이스 | Supabase 클라이언트 및 모든 DB 함수 |
| `storage.ts` | 파일 저장소 | Supabase Storage 업로드/다운로드 함수 |

#### 2. 라우터 파일

| 파일 | 역할 | 주요 API |
|------|------|----------|
| `routers.ts` | 메인 라우터 | 모든 라우터 통합 및 export |
| `companies-router.ts` | 회사 관리 | list, create, update, delete, listByType |
| `users-router.ts` | 사용자 관리 | list, create, update, delete, pinLogin |
| `equipment-types-router.ts` | 장비 유형 | list, create, update, delete |
| `worker-types-router.ts` | 인력 유형 | list, create, update, delete |
| `entry-request-router-v2.ts` | 반입 요청 | create, list, getById, bpApprove, epApprove, **validateDocuments** ✨ |
| `deployment-router.ts` | 투입 관리 | create, list, getById, update |
| `work-confirmation-router.ts` | 작업확인서 | create, list, getById, bpConfirm |
| `location-router.ts` | GPS 위치 추적 | log, getLatest, getAllActive |
| `emergency-router.ts` | 긴급 알림 | create, list, getById, resolve |
| `mobile-router.ts` | 모바일 앱 | startWorkSession, endWorkSession, startBreak, endBreak, **getAllActiveSessions** ✨ |

---

## 🗄️ 데이터베이스 테이블 구조

### 1. 기본 테이블

| 테이블명 | 설명 | 주요 컬럼 |
|---------|------|----------|
| `companies` | 회사 정보 | id, name, company_type (owner/bp/ep), business_number |
| `users` | 사용자 정보 | id, email, name, role, company_id, pin |
| `equipment_types` | 장비 유형 | id, name, category, required_docs |
| `worker_types` | 인력 유형 | id, name, category, required_docs |
| `equipment` | 장비 정보 | id, reg_num, type_id, owner_company_id, status |
| `workers` | 인력 정보 | id, name, type_id, owner_company_id, status |

### 2. 서류 관리

| 테이블명 | 설명 | 주요 컬럼 |
|---------|------|----------|
| `docs_compliance` | 서류 정보 | id, target_type (equipment/worker), target_id, doc_type, file_url, status (pending/approved/rejected), expiry_date |

### 3. 반입 요청

| 테이블명 | 설명 | 주요 컬럼 |
|---------|------|----------|
| `entry_requests` | 반입 요청 | id, request_number, owner_company_id, target_bp_company_id, target_ep_company_id, status (owner_requested/bp_approved/ep_approved/rejected), purpose, requested_start_date, requested_end_date |
| `entry_request_items` | 반입 요청 항목 | id, entry_request_id, request_type (equipment_with_worker/equipment_only/worker_only), equipment_id, worker_id |

### 4. 투입 관리

| 테이블명 | 설명 | 주요 컬럼 |
|---------|------|----------|
| `deployments` | 투입 정보 | id, deployment_number, entry_request_id, deployment_date, status |
| `deployment_items` | 투입 항목 | id, deployment_id, equipment_id, worker_id, work_type (일대/월대/O/T/철야) |

### 5. 작업확인서

| 테이블명 | 설명 | 주요 컬럼 |
|---------|------|----------|
| `work_confirmations` | 작업확인서 | id, confirmation_number, deployment_id, bp_company_id, work_date, work_hours, bp_signature_data, bp_confirmed_at, status (pending/confirmed/rejected) |

### 6. GPS 및 작업 세션 ✨

| 테이블명 | 설명 | 주요 컬럼 |
|---------|------|----------|
| `work_sessions` | 작업 세션 | id, worker_id, equipment_id, work_date, start_time, end_time, status (working/break/overtime/completed), break_duration, total_work_minutes |
| `location_logs` | 위치 기록 | id, worker_id, equipment_id, latitude, longitude, accuracy, logged_at |
| `emergency_alerts` | 긴급 알림 | id, worker_id, equipment_id, alert_type (사고/고장/안전위험/기타), latitude, longitude, description, status (active/resolved/false_alarm), resolved_by, resolution_note |

---

## 🔑 환경 변수 (.env)

```env
# Supabase 데이터베이스
DATABASE_URL=postgresql://...
SUPABASE_URL=https://zlgehckxiuhjpfjlaycf.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Google Maps API
GOOGLE_MAPS_API_KEY=AIzaSy...

# JWT 인증
JWT_SECRET=your-secret-key

# 서버 포트
PORT=3000
```

---

## 📦 주요 의존성

### 프론트엔드

```json
{
  "react": "^18.2.0",
  "react-dom": "^18.2.0",
  "typescript": "^5.0.0",
  "vite": "^5.0.0",
  "tailwindcss": "^3.4.0",
  "@tanstack/react-query": "^5.0.0",
  "@trpc/client": "^10.45.0",
  "@trpc/react-query": "^10.45.0",
  "lucide-react": "^0.263.1",
  "sonner": "^1.0.0",
  "@googlemaps/js-api-loader": "^1.16.0"
}
```

### 백엔드

```json
{
  "express": "^4.18.0",
  "@trpc/server": "^10.45.0",
  "@supabase/supabase-js": "^2.38.0",
  "drizzle-orm": "^0.29.0",
  "zod": "^3.22.0",
  "nanoid": "^5.0.0",
  "tsx": "^4.7.0"
}
```

---

## 🚀 실행 방법

### 1. 의존성 설치

```bash
cd /home/ubuntu/construction-equipment-management
pnpm install
```

### 2. 환경 변수 설정

`.env` 파일이 이미 설정되어 있습니다.

### 3. 개발 서버 시작

```bash
pnpm dev
```

서버가 http://localhost:3000 에서 실행됩니다.

### 4. 포트 노출 (Manus 환경)

```bash
# 포트 3000 또는 3001 노출
```

---

## 📝 코드 스타일 및 규칙

### 1. 파일 명명 규칙

- **컴포넌트**: PascalCase (예: `DashboardLayout.tsx`)
- **라우터**: kebab-case (예: `entry-request-router-v2.ts`)
- **유틸리티**: camelCase (예: `db.ts`, `storage.ts`)

### 2. 변수 명명 규칙

- **React 상태**: camelCase (예: `selectedEquipmentIds`)
- **데이터베이스 컬럼**: snake_case (예: `owner_company_id`)
- **API 파라미터**: camelCase (예: `targetBpCompanyId`)

### 3. 컴포넌트 구조

```typescript
// 1. Imports
import { useState } from "react";
import { trpc } from "@/lib/trpc";

// 2. Types
interface Props {
  // ...
}

// 3. Component
export default function ComponentName() {
  // 3.1. State
  const [state, setState] = useState();

  // 3.2. API Queries
  const { data } = trpc.api.list.useQuery();

  // 3.3. Mutations
  const createMutation = trpc.api.create.useMutation();

  // 3.4. Handlers
  const handleSubmit = () => {
    // ...
  };

  // 3.5. Render
  return (
    // JSX
  );
}
```

---

## 🔄 Git 워크플로우 (권장)

### 1. 브랜치 전략

- `main`: 프로덕션 브랜치
- `develop`: 개발 브랜치
- `feature/*`: 기능 개발 브랜치
- `bugfix/*`: 버그 수정 브랜치

### 2. 커밋 메시지 규칙

```
feat: 새로운 기능 추가
fix: 버그 수정
docs: 문서 수정
style: 코드 포맷팅
refactor: 코드 리팩토링
test: 테스트 코드 추가
chore: 빌드 설정 변경
```

---

**작성일**: 2025-10-26  
**작성자**: AI Assistant  
**버전**: 2.0

