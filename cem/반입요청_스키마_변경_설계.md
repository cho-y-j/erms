# 반입 요청 프로세스 개선 - 스키마 변경 설계

## 현재 문제점

### 1. 기존 `entry_requests` 테이블의 한계
- **단일 장비/인력만 지원**: `equipmentId`, `workerId` 필드가 단일 값만 저장
- **다중 선택 불가**: 여러 장비 또는 여러 인력을 한 번에 반입 요청할 수 없음
- **유연성 부족**: 장비만, 인력만, 또는 둘 다 선택하는 시나리오를 지원하지 못함

### 2. 서류 검증 로직 부재
- 반입 요청 시 서류 상태 확인 로직이 없음
- 서류 만료일 체크 기능이 없음
- 서류 승인 상태 확인이 없음

## 개선 방안

### 1. 테이블 구조 변경

#### A. `entry_requests` 테이블 수정
**변경 사항**:
- `equipmentId`, `workerId` 필드 **제거** (NOT NULL 제약 제거)
- 다중 장비/인력은 별도 테이블(`entry_request_items`)로 관리

**새로운 필드 추가**:
- `documents_verified_at`: 서류 검증 완료 시각
- `documents_verification_result`: 서류 검증 결과 (JSON)

#### B. `entry_request_items` 테이블 신규 생성
**목적**: 한 반입 요청에 여러 장비/인력을 연결

**필드 구조**:
```typescript
{
  id: string (PK)
  entryRequestId: string (FK → entry_requests.id)
  itemType: 'equipment' | 'worker'
  itemId: string (equipment.id 또는 workers.id)
  
  // 서류 검증 결과
  documentStatus: 'valid' | 'expired' | 'missing' | 'pending'
  documentIssues: JSON // 서류 문제 상세 정보
  
  createdAt: timestamp
}
```

#### C. 서류 검증 결과 구조 (JSON)
```json
{
  "itemId": "equip_001",
  "itemType": "equipment",
  "itemName": "굴삭기 12가1234",
  "requiredDocs": [
    {
      "docName": "차량등록증",
      "status": "valid",
      "expiryDate": "2026-12-31",
      "daysUntilExpiry": 430
    },
    {
      "docName": "보험증권",
      "status": "expired",
      "expiryDate": "2024-10-01",
      "daysUntilExpiry": -23
    }
  ],
  "overallStatus": "invalid",
  "issues": ["보험증권이 만료되었습니다"]
}
```

### 2. 워크플로우 상태 변경

#### 기존 상태
```
bp_requested → owner_reviewing → owner_approved → 
bp_reviewing → bp_approved → ep_reviewing → ep_approved
```

#### 개선된 상태
```
bp_draft (임시저장)
  ↓
bp_requested (요청 제출 - 서류 검증 완료 필수)
  ↓
owner_reviewing (Owner 검토 중)
  ↓
owner_approved (Owner 승인 + 작업계획서 첨부)
  ↓
ep_reviewing (EP 최종 검토 중)
  ↓
ep_approved (EP 최종 승인 - 반입 완료)
  ↓
rejected (반려 - 어느 단계에서나 가능)
```

### 3. 서류 검증 로직

#### 검증 항목
1. **필수 서류 존재 여부**
   - 장비 종류별 필수 서류 (`type_docs`)
   - 인력 유형별 필수 서류 (`worker_docs`)

2. **서류 승인 상태**
   - `docs_compliance.status = 'approved'`
   - 모든 승인 단계 완료 여부

3. **서류 만료일 확인**
   - `expiryDate > 현재 날짜`
   - 만료 예정 경고 (7일, 30일 전)

#### 검증 결과
- **valid**: 모든 서류 정상
- **warning**: 만료 예정 (7일 이내)
- **expired**: 만료된 서류 존재
- **missing**: 필수 서류 누락
- **pending**: 승인 대기 중인 서류 존재

### 4. 프론트엔드 개선 사항

#### A. 반입 요청 화면
```
[반입 요청 등록]

1. 장비 선택 (다중 선택 가능)
   ☑ 굴삭기 12가1234 [서류 상태: ✓ 정상]
   ☑ 덤프트럭 34나5678 [서류 상태: ⚠ 만료 예정 (5일)]
   ☐ 크레인 56다9012 [서류 상태: ✗ 보험 만료]

2. 인력 선택 (다중 선택 가능)
   ☑ 홍길동 (굴삭기 기사) [서류 상태: ✓ 정상]
   ☑ 김철수 (덤프 기사) [서류 상태: ✓ 정상]

3. 서류 검증 결과
   ⚠ 경고: 덤프트럭 34나5678의 보험증권이 5일 후 만료됩니다.
   ✗ 오류: 크레인 56다9012의 보험증권이 만료되었습니다.
   
   → 서류 문제가 있는 장비는 반입 요청할 수 없습니다.

[임시저장] [요청 제출]
```

#### B. Owner 승인 화면
```
[반입 요청 승인]

요청 번호: REQ-2024-001
요청자: BP 회사명 (홍길동)
요청일: 2024-10-24

장비 목록:
1. 굴삭기 12가1234
   - 차량등록증: ✓ 정상 (만료일: 2026-12-31)
   - 보험증권: ✓ 정상 (만료일: 2025-06-30)
   [PDF 보기]

2. 덤프트럭 34나5678
   - 차량등록증: ✓ 정상 (만료일: 2027-03-15)
   - 보험증권: ⚠ 만료 예정 (만료일: 2024-10-29, 5일 남음)
   [PDF 보기]

인력 목록:
1. 홍길동 (굴삭기 기사)
   - 자격증: ✓ 정상 (만료일: 2026-08-20)
   - 건강검진서: ✓ 정상 (만료일: 2025-05-10)
   [PDF 보기]

작업계획서 첨부: [파일 선택]

[반려] [승인]
```

#### C. EP 최종 승인 화면
```
[최종 승인]

요청 번호: REQ-2024-001
BP 요청: 2024-10-24 10:30
Owner 승인: 2024-10-24 14:20

장비/인력 서류 상태: ✓ 모두 정상
작업계획서: ✓ 첨부됨 [다운로드]

[반려] [최종 승인]
```

## SQL 변경 사항 요약

### 1. `entry_requests` 테이블 수정
```sql
-- equipmentId, workerId 필드를 NULL 허용으로 변경 (기존 데이터 호환)
ALTER TABLE entry_requests 
  ALTER COLUMN equipment_id DROP NOT NULL,
  ALTER COLUMN worker_id DROP NOT NULL;

-- 서류 검증 관련 필드 추가
ALTER TABLE entry_requests
  ADD COLUMN documents_verified_at TIMESTAMP,
  ADD COLUMN documents_verification_result JSONB;

-- 상태 enum에 'bp_draft' 추가
ALTER TYPE entry_request_status ADD VALUE 'bp_draft' BEFORE 'bp_requested';
```

### 2. `entry_request_items` 테이블 생성
```sql
-- item_type enum 생성
CREATE TYPE entry_request_item_type AS ENUM ('equipment', 'worker');

-- document_status enum 생성
CREATE TYPE document_status AS ENUM ('valid', 'warning', 'expired', 'missing', 'pending');

-- entry_request_items 테이블 생성
CREATE TABLE entry_request_items (
  id VARCHAR(64) PRIMARY KEY,
  entry_request_id VARCHAR(64) NOT NULL REFERENCES entry_requests(id) ON DELETE CASCADE,
  item_type entry_request_item_type NOT NULL,
  item_id VARCHAR(64) NOT NULL,
  
  document_status document_status DEFAULT 'pending' NOT NULL,
  document_issues JSONB,
  
  created_at TIMESTAMP DEFAULT NOW()
);

-- 인덱스 생성
CREATE INDEX idx_entry_request_items_request_id ON entry_request_items(entry_request_id);
CREATE INDEX idx_entry_request_items_item ON entry_request_items(item_type, item_id);
```

## 구현 순서

### Phase 1: 데이터베이스 스키마 변경
1. SQL 스크립트 작성
2. Supabase SQL Editor에서 실행
3. Drizzle 스키마 파일 업데이트

### Phase 2: 백엔드 API 구현
1. 서류 검증 함수 구현 (`validateDocuments`)
2. 반입 요청 API 수정 (`entryRequests.create`)
3. 승인 API 수정 (`entryRequests.approve`)

### Phase 3: 프론트엔드 UI 구현
1. 장비/인력 다중 선택 컴포넌트
2. 서류 상태 표시 컴포넌트
3. 반입 요청 폼 개선
4. 승인 화면 개선

### Phase 4: 테스트
1. 단위 테스트 (서류 검증 로직)
2. 통합 테스트 (전체 워크플로우)
3. 사용자 테스트

## 다음 단계

1. **SQL 스크립트 생성** → Supabase에서 실행
2. **Drizzle 스키마 업데이트** → TypeScript 타입 생성
3. **백엔드 API 구현** → 서류 검증 로직 포함
4. **프론트엔드 UI 구현** → 다중 선택 및 상태 표시
5. **테스트 및 배포**

