# 반입 요청 프로세스 개선 - 작업 진행 상황

## 작업 일시
2024년 10월 24일

## 목표
반입 요청 프로세스를 개선하여 장비/인력 다중 선택, 서류 자동 검증, 3단계 승인 워크플로우(BP→Owner→EP)를 구현한다.

## ✅ 완료된 작업

### Phase 1: 스키마 분석 및 설계 (완료)
- [x] 현재 스키마 분석
- [x] 변경 사항 설계 문서 작성
- [x] 워크플로우 정의

**산출물**:
- `반입요청_스키마_변경_설계.md`

### Phase 2: 데이터베이스 스키마 변경 (완료)
- [x] SQL 마이그레이션 스크립트 작성
- [x] ENUM 타입 정의
- [x] 테이블 구조 변경
- [x] 인덱스 및 뷰 생성
- [x] 유틸리티 함수 작성

**산출물**:
- `supabase_schema_migration.sql`

**주요 변경 사항**:
1. **새로운 ENUM 타입**
   - `entry_request_item_type`: 'equipment' | 'worker'
   - `document_status`: 'valid' | 'warning' | 'expired' | 'missing' | 'pending'

2. **entry_requests 테이블 수정**
   - `equipment_id`, `worker_id`: NULL 허용으로 변경
   - `documents_verified_at`: 서류 검증 완료 시각
   - `documents_verification_result`: 서류 검증 결과 (JSONB)

3. **entry_request_items 테이블 생성**
   - 한 반입 요청에 여러 장비/인력 연결
   - 각 아이템별 서류 검증 상태 저장

4. **유틸리티 함수**
   - `get_days_until_expiry()`: 만료일까지 남은 일수 계산
   - `get_document_status()`: 서류 상태 자동 판단

5. **조회 뷰**
   - `v_equipment_document_status`: 장비별 서류 상태
   - `v_worker_document_status`: 인력별 서류 상태

### Phase 3: 백엔드 API 구현 (완료)
- [x] 서류 검증 로직 구현
- [x] 데이터베이스 함수 추가
- [x] 반입 요청 라우터 개선
- [x] Drizzle 스키마 업데이트

**산출물**:
1. `server/document-validation.ts` - 서류 검증 로직
2. `server/entry-request-router-new.ts` - 개선된 라우터
3. `drizzle/schema.ts` - 스키마 업데이트
4. `server/db.ts` - DB 함수 추가

**주요 기능**:

#### 1. 서류 검증 로직 (`document-validation.ts`)
```typescript
// 장비 서류 검증
validateEquipmentDocuments(equipmentId: string): Promise<ItemValidationResult>

// 인력 서류 검증
validateWorkerDocuments(workerId: string): Promise<ItemValidationResult>

// 전체 반입 요청 검증
validateEntryRequest(equipmentIds: string[], workerIds: string[]): Promise<ValidationResult>
```

**검증 항목**:
- 필수 서류 존재 여부
- 서류 승인 상태 (approved)
- 서류 만료일 확인
- 만료 예정 경고 (7일 이내)

**검증 결과**:
- `valid`: 모든 서류 정상
- `warning`: 만료 예정 (7일 이내)
- `expired`: 만료된 서류 존재
- `missing`: 필수 서류 누락
- `pending`: 승인 대기 중

#### 2. 개선된 API 엔드포인트 (`entry-request-router-new.ts`)

**조회**:
- `list`: 반입 요청 목록 조회
- `getById`: 반입 요청 상세 조회 (아이템 포함)

**서류 검증**:
- `validateDocuments`: 반입 요청 전 서류 검증

**반입 요청 생성**:
- `create`: 반입 요청 생성 (다중 선택 지원, 서류 검증 필수)
- `saveDraft`: 임시 저장 (서류 검증 없이)

**승인 워크플로우**:
- `ownerApprove`: Owner 승인 + 작업계획서 첨부
- `epApprove`: EP 최종 승인
- `reject`: 반려 (모든 단계에서 가능)

#### 3. 데이터베이스 함수 추가 (`db.ts`)
```typescript
// 반입 요청 아이템 관리
createEntryRequestItem(data: InsertEntryRequestItem)
createEntryRequestItems(items: InsertEntryRequestItem[])
getEntryRequestItems(entryRequestId: string): Promise<EntryRequestItem[]>
updateEntryRequestItem(id: string, data: Partial<InsertEntryRequestItem>)
deleteEntryRequestItems(entryRequestId: string)
```

## ⏳ 진행 중인 작업

### Phase 4: 프론트엔드 UI 구현 (대기 중)
- [ ] 장비/인력 다중 선택 컴포넌트
- [ ] 서류 상태 표시 컴포넌트
- [ ] 반입 요청 폼 개선
- [ ] Owner 승인 화면 개선
- [ ] EP 승인 화면 개선

### Phase 5: 테스트 및 결과 보고 (대기 중)
- [ ] 단위 테스트 (서류 검증 로직)
- [ ] 통합 테스트 (전체 워크플로우)
- [ ] 사용자 테스트

## 🔄 다음 단계

### 1. Supabase SQL 실행 (필수!)
**파일**: `supabase_schema_migration.sql`

**실행 방법**:
1. Supabase 대시보드 접속: https://zlgehckxiuhjpfjlaycf.supabase.co
2. SQL Editor 메뉴 선택
3. `supabase_schema_migration.sql` 내용 복사
4. 붙여넣기 후 실행

**예상 결과**:
```
생성된 테이블:
  - entry_request_items

생성된 ENUM 타입:
  - entry_request_item_type
  - document_status

생성된 함수:
  - get_days_until_expiry()
  - get_document_status()

생성된 뷰:
  - v_equipment_document_status
  - v_worker_document_status
```

### 2. 라우터 교체
기존 `routers.ts`의 `entryRequests` 라우터를 새로운 라우터로 교체

### 3. 프론트엔드 구현
- 반입 요청 페이지 개선
- 장비/인력 다중 선택 UI
- 서류 상태 표시
- 승인 화면 개선

### 4. 테스트
- 전체 워크플로우 테스트
- 서류 검증 로직 테스트
- 사용자 시나리오 테스트

## 📊 워크플로우 다이어그램

```
[BP] 반입 요청 생성
  ↓
  - 장비/인력 다중 선택
  - 서류 자동 검증
  - 검증 실패 시 요청 불가
  ↓
[Owner] 검토 및 승인
  ↓
  - PDF 서류 확인
  - 서류 만료일 확인
  - 작업계획서 첨부
  - 승인 또는 반려
  ↓
[EP] 최종 승인
  ↓
  - 전체 내용 확인
  - 서류 만료일 확인
  - 최종 승인 또는 반려
  ↓
[완료] 반입 승인 완료
```

## 🎯 기대 효과

### 1. 업무 효율성 향상
- 여러 장비/인력을 한 번에 반입 요청 가능
- 서류 검증 자동화로 수작업 감소
- 만료 예정 서류 사전 경고

### 2. 서류 관리 강화
- 필수 서류 누락 방지
- 만료된 서류로 인한 문제 사전 차단
- 서류 승인 상태 실시간 확인

### 3. 워크플로우 명확화
- 3단계 승인 프로세스 명확화
- 각 단계별 책임 소재 명확화
- 반려 사유 기록 및 추적

## 📝 참고 사항

### 서류 상태 코드
- `valid`: 정상 (만료일 7일 이상 남음)
- `warning`: 만료 예정 (7일 이내)
- `expired`: 만료됨
- `missing`: 필수 서류 누락
- `pending`: 승인 대기 중

### 반입 요청 상태
- `bp_draft`: 임시 저장
- `bp_requested`: BP 요청 제출
- `owner_approved`: Owner 승인 완료
- `ep_approved`: EP 최종 승인 완료
- `rejected`: 반려

### 주의 사항
1. SQL 실행 전 데이터 백업 권장
2. 기존 데이터는 자동으로 마이그레이션됨
3. 새로운 라우터 적용 시 기존 API 호출 부분 수정 필요

## 🔗 관련 파일

### 설계 문서
- `반입요청_스키마_변경_설계.md`

### SQL 스크립트
- `supabase_schema_migration.sql`

### 백엔드 코드
- `server/document-validation.ts`
- `server/entry-request-router-new.ts`
- `server/db.ts`
- `drizzle/schema.ts`

### 프론트엔드 (예정)
- `client/src/pages/EntryRequests.tsx` (수정 예정)
- `client/src/components/EntryRequestForm.tsx` (신규 예정)
- `client/src/components/DocumentStatusBadge.tsx` (신규 예정)

---

**작업 진행률**: 60% (3/5 단계 완료)

**다음 작업**: Supabase SQL 실행 → 프론트엔드 구현 → 테스트

