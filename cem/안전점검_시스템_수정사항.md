# 안전점검 시스템 수정사항

날짜: 2025-11-03

## 수정된 문제

### 1. EP/Admin에서 점검 내역이 보이지 않던 문제 해결

#### 문제 원인
1. **역할(Role) 비교 시 대소문자 처리 오류**
   - 데이터베이스에 저장된 역할과 코드에서 비교하는 역할의 대소문자가 일치하지 않음
   - 예: DB에 "EP" 저장, 코드에서 "ep"와 비교 → 불일치로 권한 오류 발생

2. **EP 리뷰 화면에서 확인완료된 내역을 볼 수 없음**
   - `listSubmittedInspections` API가 `status: "submitted"` 만 조회
   - EP가 확인한 후 `status: "reviewed"`로 변경되면 목록에서 사라짐

#### 해결 방법

**파일: `server/safety-inspection-router.ts`**

1. **모든 역할 비교에 `.toLowerCase()` 추가** (5곳 수정)
   ```typescript
   // 수정 전
   if (ctx.user.role === "inspector")

   // 수정 후
   const userRole = ctx.user.role?.toLowerCase();
   if (userRole === "inspector")
   ```

2. **EP 리뷰 화면에서 전체 이력 조회**
   ```typescript
   // 수정 전: submitted만 조회
   return await db.getSafetyInspections({
     status: "submitted",
     inspectorType: "inspector",
   });

   // 수정 후: submitted와 reviewed 모두 조회
   const inspections = await db.getSafetyInspections({
     inspectorType: "inspector",
   });
   return inspections.filter((i: any) =>
     i.status === "submitted" || i.status === "reviewed"
   );
   ```

### 2. 모바일 점검원 UI 개선

#### 수정 내용
1. **점검원 메인 화면** (`InspectorMain.tsx`)
   - 왼쪽 메뉴 버튼 제거
   - 기본 하단 네비게이션 제거
   - 커스텀 2탭 네비게이션 추가
     - 점검 작성 탭
     - 점검 내역 탭

2. **점검 내역 화면 신규 생성** (`SafetyInspectionHistory.tsx`)
   - 차량번호로 검색
   - 날짜로 필터링
   - 통계 카드 (전체/확인완료/임시저장)
   - 점검 내역 목록

3. **차량 검색 기능 개선**
   - API 엔드포인트 수정: `mobile.inspector.searchEquipmentByLastFour` → `safetyInspection.searchEquipment`
   - 4자리 제한 제거 → 부분 검색 지원
   - 예: "3456", "가3456", "12가3456" 모두 가능

### 3. 템플릿 매칭 문제 해결

#### 문제
- 범용 샘플 템플릿 "스카이장비 안전점검"이 장비 종류별 템플릿보다 우선 표시됨

#### 해결
- 범용 샘플 템플릿 비활성화 (`disable-sample-template.mjs` 실행)
- 이제 장비 종류에 맞는 전용 템플릿만 표시됨

## 테스트 계정

### 점검원 (Inspector)
```
이메일: inspector@test.com
비밀번호: test123
역할: inspector
접속 URL: http://localhost:3000/mobile/inspector
```

### EP (Engineering Partner)
```
이메일: ep@test.com
비밀번호: test123
역할: ep
점검 확인 URL: http://localhost:3000/safety-inspection-review
```

### Admin
```
이메일: admin@test.com
비밀번호: test123
역할: admin
점검 내역 URL: http://localhost:3000/admin/safety-inspections
```

## 테스트 시나리오

### 1단계: 점검원 - 안전점검 작성 및 제출

1. 점검원으로 로그인 (inspector@test.com / test123)
2. `/mobile/inspector` 화면에서 차량번호 검색
   - 예: 등록된 장비의 차량번호 입력
3. 검색된 장비 선택
4. 점검 빈도 선택 (일일/주간/월간/필요시)
5. 점검 항목별로 결과 입력
   - 양호 / 조정 / 교환 / 해당없음
6. 전자서명 입력
7. "점검 제출" 버튼 클릭

### 2단계: EP - 점검 확인 및 승인

1. EP로 로그인 (ep@test.com / test123)
2. `/safety-inspection-review` 화면 접속
3. 제출된 점검 목록에서 확인할 점검 선택
4. "상세보기" 클릭하여 점검 내용 확인
5. "확인 완료" 버튼 클릭
6. 필요시 의견 입력
7. 확인 완료

### 3단계: Admin - 전체 점검 내역 조회

1. Admin으로 로그인 (admin@test.com / test123)
2. `/admin/safety-inspections` 화면 접속
3. 필터 사용하여 원하는 점검 내역 조회
   - 상태별: 임시저장/제출됨/확인완료
   - 점검 빈도별: 일일/주간/월간/필요시
   - 날짜 범위 지정
4. 상세보기로 점검 내용 확인

## 현재 데이터베이스 상태

- **점검 템플릿**: 5개 (1개 비활성화, 4개 활성화)
- **점검 기록**: 0개 (신규 시스템이므로 점검원이 작성 필요)
- **장비**: 등록된 장비 있음 (검색 가능)

## 점검 상태 흐름

```
draft (임시저장)
  ↓ (점검원이 제출)
submitted (제출됨)
  ↓ (EP가 확인)
reviewed (확인완료)
```

## 주요 파일 변경 사항

### 서버
- `server/safety-inspection-router.ts`: 역할 비교 로직 수정, EP 조회 로직 개선
- `server/db.ts`: 템플릿 조회 시 join 제거, 수동 매핑 (이전 세션에서 수정)

### 클라이언트
- `client/src/pages/mobile/InspectorMain.tsx`: 검색 API 수정, 커스텀 네비게이션 추가
- `client/src/pages/mobile/SafetyInspectionHistory.tsx`: 신규 생성 - 점검 내역 화면
- `client/src/App.tsx`: 점검 내역 라우트 추가

### 유틸리티 스크립트
- `check-inspections.mjs`: 점검 기록 확인
- `create-inspector-user.mjs`: 테스트 점검원 생성
- `disable-sample-template.mjs`: 범용 템플릿 비활성화

## 다음 단계

1. ✅ 점검원 사용자 생성 완료
2. ⏳ 점검원이 모바일에서 첫 점검 작성 및 제출
3. ⏳ EP가 제출된 점검 확인 및 승인
4. ⏳ Admin이 전체 내역 조회 확인

## 참고사항

- 모든 역할 비교는 이제 `.toLowerCase()`를 사용하여 대소문자 무관하게 동작
- EP 화면에서는 제출된 점검과 확인완료된 점검 모두 표시
- Admin 화면에서는 모든 상태의 점검 내역 조회 가능
- 점검원 화면은 모바일 최적화되어 있음 (터치 친화적 UI)
