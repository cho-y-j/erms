# 파일명 한글 문제 및 중복 등록 번호 해결 완료

**작성일**: 2025-10-26  
**문제**: 
1. 한글 파일명으로 인한 Supabase Storage 업로드 실패
2. 중복된 등록 번호로 인한 장비 등록 실패

---

## ✅ 해결 완료

### 문제 1: 한글 파일명 업로드 실패

**에러 메시지**:
```
Storage upload failed: Invalid key: equipment/U7O2_rAH8T1OT7uR3Noon/NTCgut05Ky0WumoZ3dDdt_캡처.JPG
```

**원인**: Supabase Storage는 파일 경로에 한글을 지원하지 않음

**해결 방법**: 파일명을 고유한 ID + 확장자로 변경

#### 수정된 코드 (server/routers.ts)

**equipment.createWithDocs (line 463-469)**:
```typescript
// 파일명을 안전하게 처리 (한글 제거 및 URL-safe)
const fileExtension = doc.fileName.split('.').pop() || 'file';
const safeFileName = `${nanoid()}.${fileExtension}`;

// Supabase Storage에 파일 업로드
const filePath = `equipment/${equipmentId}/${safeFileName}`;
const { url } = await storagePut(filePath, buffer, doc.mimeType);
```

**workers.createWithDocs (line 587-593)**:
- 동일한 방식으로 수정

**변경 전**:
```
equipment/abc123/xyz789_캡처.JPG
```

**변경 후**:
```
equipment/abc123/NTCgut05Ky0WumoZ3dDdt.JPG
```

---

### 문제 2: 중복 등록 번호

**에러 메시지**:
```
duplicate key value violates unique constraint "equipment_reg_num_key"
```

**원인**: 이미 등록된 장비 번호를 다시 사용하려고 함

**해결 방법**: 프론트엔드에서 중복 체크 추가

#### 수정된 코드 (client/src/pages/Equipment.tsx)

**handleSubmit 함수 (line 144-152)**:
```typescript
// 등록 번호 중복 체크
const isDuplicate = equipmentList?.some(
  (eq) => eq.regNum === formData.regNum
);

if (isDuplicate) {
  toast.error(`등록 번호 "${formData.regNum}"는 이미 사용 중입니다.`);
  return;
}
```

**동작**:
1. 등록 버튼 클릭 시 기존 장비 목록에서 중복 확인
2. 중복되면 에러 메시지 표시 및 등록 중단
3. 중복되지 않으면 정상 진행

---

## 🔧 수정된 파일 목록

### 1. server/routers.ts
- `equipment.createWithDocs` (line 463-469) - 파일명 안전 처리
- `workers.createWithDocs` (line 587-593) - 파일명 안전 처리

### 2. client/src/pages/Equipment.tsx
- `handleSubmit` (line 144-152) - 등록 번호 중복 체크 추가

---

## 🚀 테스트 서버

**URL**: https://3000-i2rbu5qzksu646zz8h6uy-87777a64.manus-asia.computer

**상태**: 실행 중 ✅ (자동 재시작됨)

---

## 🧪 테스트 시나리오

### 1. 한글 파일명 업로드 테스트
1. Owner 계정으로 로그인
2. "장비 관리" → "장비 등록"
3. 장비 정보 입력
4. **한글 파일명(예: "캡처.JPG")의 파일 업로드**
5. "등록" 버튼 클릭
6. **✅ 정상적으로 등록되는지 확인**
7. "서류 관리" 페이지에서 서류 확인
8. **✅ 파일이 정상적으로 표시되고 다운로드되는지 확인**

### 2. 중복 등록 번호 테스트
1. 장비를 하나 등록 (예: 등록 번호 "ABC-123")
2. 다시 "장비 등록" 클릭
3. **동일한 등록 번호 "ABC-123" 입력**
4. "등록" 버튼 클릭
5. **✅ "등록 번호 'ABC-123'는 이미 사용 중입니다." 에러 메시지 표시**
6. 등록이 중단되고 폼이 유지됨
7. 다른 등록 번호로 변경하여 재시도
8. **✅ 정상적으로 등록됨**

---

## 📊 파일명 변환 예시

| 원본 파일명 | 변환된 파일명 | 저장 경로 |
|------------|-------------|----------|
| 캡처.JPG | NTCgut05Ky0WumoZ3dDdt.JPG | equipment/abc123/NTCgut05Ky0WumoZ3dDdt.JPG |
| 면허증.pdf | XyZ789AbC123.pdf | equipment/abc123/XyZ789AbC123.pdf |
| 사진 001.png | QwErTy456.png | worker/def456/QwErTy456.png |

**장점**:
- URL-safe: 모든 특수문자 제거
- 고유성: nanoid()로 충돌 방지
- 확장자 유지: 파일 형식 보존

---

## 🔍 디버깅 로그

### 정상 업로드 시
```
[Storage] File uploaded: equipment/abc123/NTCgut05Ky0WumoZ3dDdt.JPG -> https://...
[Equipment] Document uploaded: 면허증 for equipment abc123
```

### 중복 등록 번호 시 (프론트엔드)
```
Toast: 등록 번호 "ABC-123"는 이미 사용 중입니다.
```

---

## ⚠️ 주의 사항

### 1. 원본 파일명 손실

파일명이 고유 ID로 변경되므로, **원본 파일명은 `docs_compliance.file_name` 컬럼에 저장**됩니다.

**확인 방법**:
```sql
SELECT file_name, file_url FROM docs_compliance WHERE target_id = 'abc123';
```

결과:
```
file_name: 캡처.JPG
file_url: https://.../equipment/abc123/NTCgut05Ky0WumoZ3dDdt.JPG
```

### 2. 다운로드 시 파일명

현재 다운로드 시 변환된 파일명(예: `NTCgut05Ky0WumoZ3dDdt.JPG`)으로 저장됩니다.

**개선 방안**: 원본 파일명으로 다운로드되도록 수정
```typescript
<Button variant="ghost" size="sm" asChild>
  <a 
    href={doc.fileUrl} 
    download={doc.fileName} // 원본 파일명 사용
    target="_blank" 
    rel="noopener noreferrer"
  >
    <Download className="h-4 w-4" />
  </a>
</Button>
```

### 3. 중복 체크 타이밍

현재는 **프론트엔드에서만** 중복 체크를 수행합니다. 동시에 여러 사용자가 같은 번호를 입력하면 여전히 에러가 발생할 수 있습니다.

**개선 방안**: 백엔드에서도 중복 체크 추가
```typescript
// server/routers.ts - equipment.createWithDocs
const existing = await db.getEquipmentByRegNum(input.regNum);
if (existing) {
  throw new TRPCError({
    code: "CONFLICT",
    message: `등록 번호 "${input.regNum}"는 이미 사용 중입니다.`,
  });
}
```

---

## 🔄 향후 개선 사항

### 1. 원본 파일명으로 다운로드 (우선순위: 중간)
현재는 변환된 파일명으로 다운로드되므로, 원본 파일명을 사용하도록 수정

### 2. 백엔드 중복 체크 추가 (우선순위: 중간)
동시성 문제를 방지하기 위해 백엔드에서도 중복 체크 추가

### 3. 파일명 정규화 (우선순위: 낮음)
한글을 영문으로 변환하여 원본 파일명을 유지
- 예: "캡처.JPG" → "capture.JPG"
- 라이브러리: `transliteration` 또는 `hangul-romanization`

### 4. 파일 형식 제한 (우선순위: 낮음)
허용된 파일 형식만 업로드 가능하도록 제한
- 이미지: jpg, jpeg, png, gif
- 문서: pdf

---

## ✨ 완료!

한글 파일명 문제와 중복 등록 번호 문제가 모두 해결되었습니다.

**테스트 서버 URL**: https://3000-i2rbu5qzksu646zz8h6uy-87777a64.manus-asia.computer

**다음 단계**:
1. 한글 파일명으로 장비 등록 테스트
2. 중복 등록 번호로 등록 시도하여 에러 확인
3. 서류 관리 페이지에서 서류 확인 및 다운로드

---

**작성일**: 2025-10-26  
**작성자**: AI Assistant  
**버전**: 1.0

